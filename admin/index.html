<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endura Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --forest: #4A7C59;
            --forest-light: #6B9B7A;
            --forest-dark: #2d5a3a;
            --text: #1a1a2e;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --accent: #10b981;
            --red: #ef4444;
            --amber: #f59e0b;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --sidebar-w: 240px;
        }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ---- Login ---- */
        .login-wrap {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 20px;
        }
        .login-card {
            background: var(--card); border-radius: 20px; padding: 48px;
            box-shadow: 0 20px 60px rgba(0,0,0,.08); max-width: 400px; width: 100%;
            text-align: center;
        }
        .login-card h1 { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
        .login-card p { color: var(--text-muted); margin-bottom: 28px; }
        .login-card input {
            width: 100%; padding: 14px 18px; border: 2px solid var(--border);
            border-radius: 12px; font-size: 15px; margin-bottom: 12px; transition: border .2s;
        }
        .login-card input:focus { outline: none; border-color: var(--forest); }
        .login-card .btn {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--forest-light), var(--forest));
            color: #fff; border: none; border-radius: 12px; font-size: 15px;
            font-weight: 600; cursor: pointer; transition: transform .15s, box-shadow .15s;
        }
        .login-card .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(74,124,89,.35); }
        .login-error { color: var(--red); font-size: 13px; margin-top: 12px; display: none; }

        /* ---- Shell ---- */
        .shell { display: none; min-height: 100vh; }
        .shell.active { display: flex; }

        /* ---- Sidebar ---- */
        .sidebar {
            width: var(--sidebar-w); background: var(--card); border-right: 1px solid var(--border);
            padding: 24px 16px; display: flex; flex-direction: column; position: fixed;
            top: 0; left: 0; bottom: 0; z-index: 10;
        }
        .sidebar .logo { display: flex; align-items: center; gap: 10px; margin-bottom: 32px; padding: 0 8px; }
        .sidebar .logo span { font-size: 28px; }
        .sidebar .logo h2 { font-size: 18px; font-weight: 800; }
        .sidebar .logo small { display: block; font-size: 11px; color: var(--text-muted); font-weight: 500; }
        .sidebar nav { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .sidebar nav a {
            display: flex; align-items: center; gap: 10px; padding: 10px 12px;
            border-radius: 10px; text-decoration: none; color: var(--text-muted);
            font-size: 14px; font-weight: 500; transition: all .15s; cursor: pointer;
        }
        .sidebar nav a:hover { background: var(--bg); color: var(--text); }
        .sidebar nav a.active { background: var(--forest); color: #fff; }
        .sidebar nav a .icon { font-size: 18px; width: 24px; text-align: center; }
        .sidebar .api-cfg {
            margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border);
        }
        .sidebar .api-cfg label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; display: block; margin-bottom: 6px; }
        .sidebar .api-cfg input {
            width: 100%; padding: 8px 10px; border: 1px solid var(--border);
            border-radius: 8px; font-size: 12px; font-family: monospace; margin-bottom: 6px;
        }
        .sidebar .api-cfg input:focus { outline: none; border-color: var(--forest); }
        .sidebar .status-dot {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            margin-right: 6px;
        }
        .sidebar .status-dot.ok { background: var(--accent); }
        .sidebar .status-dot.fail { background: var(--red); }
        .sidebar .api-status { font-size: 12px; color: var(--text-muted); }

        /* ---- Main ---- */
        .main { margin-left: var(--sidebar-w); flex: 1; padding: 32px 40px; min-height: 100vh; }
        .main .page-title { font-size: 26px; font-weight: 800; margin-bottom: 24px; }
        .page { display: none; }
        .page.active { display: block; }

        /* ---- KPI Cards ---- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 16px; margin-bottom: 28px; }
        .kpi {
            background: var(--card); border-radius: 14px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,.04);
        }
        .kpi .kpi-icon { font-size: 28px; margin-bottom: 8px; }
        .kpi .kpi-val { font-size: 32px; font-weight: 800; color: var(--forest-dark); }
        .kpi .kpi-label { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
        .kpi .kpi-sub { font-size: 11px; color: var(--accent); margin-top: 4px; font-weight: 600; }

        /* ---- Charts ---- */
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
        .chart-card {
            background: var(--card); border-radius: 14px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,.04);
        }
        .chart-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 16px; }
        .chart-card canvas { width: 100% !important; height: 200px !important; }

        /* ---- Tables ---- */
        .table-card {
            background: var(--card); border-radius: 14px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,.04); margin-bottom: 20px;
        }
        .table-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 12px; }
        .table-toolbar { display: flex; gap: 12px; margin-bottom: 16px; align-items: center; }
        .table-toolbar input {
            flex: 1; padding: 10px 14px; border: 1px solid var(--border);
            border-radius: 10px; font-size: 14px;
        }
        .table-toolbar input:focus { outline: none; border-color: var(--forest); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th {
            text-align: left; padding: 10px 12px; color: var(--text-muted);
            font-weight: 600; font-size: 11px; text-transform: uppercase;
            letter-spacing: .5px; border-bottom: 2px solid var(--border); cursor: pointer;
            user-select: none;
        }
        thead th:hover { color: var(--text); }
        tbody tr { border-bottom: 1px solid var(--border); transition: background .1s; }
        tbody tr:hover { background: #f9fafb; }
        tbody td { padding: 10px 12px; }
        .badge {
            display: inline-block; padding: 2px 8px; border-radius: 6px;
            font-size: 11px; font-weight: 600;
        }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-amber { background: #fef3c7; color: #92400e; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-purple { background: #ede9fe; color: #5b21b6; }

        /* ---- Animal Grid ---- */
        .animal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 14px; }
        .animal-card {
            background: var(--bg); border-radius: 12px; padding: 16px;
            display: flex; align-items: center; gap: 12px;
            border: 2px solid transparent; transition: all .15s;
        }
        .animal-card:hover { border-color: var(--forest-light); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.06); }
        .animal-card { cursor: pointer; }
        .animal-card .emoji { font-size: 36px; }
        .animal-card .animal-img { width: 48px; height: 48px; border-radius: 10px; object-fit: cover; }
        .animal-card .name { font-weight: 600; font-size: 14px; }
        .animal-card .status { font-size: 12px; color: var(--text-muted); }
        .animal-card .rarity-tag { font-size: 10px; font-weight: 600; margin-top: 2px; text-transform: uppercase; letter-spacing: .3px; }

        /* ---- Animal Edit Modal ---- */
        .animal-detail-img { width: 120px; height: 120px; border-radius: 16px; object-fit: cover; border: 3px solid var(--border); }
        .animal-detail-placeholder {
            width: 120px; height: 120px; border-radius: 16px; border: 3px dashed var(--border);
            display: flex; align-items: center; justify-content: center; font-size: 48px; background: var(--bg);
        }
        .animal-form label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .3px; margin-bottom: 4px; margin-top: 14px; }
        .animal-form input, .animal-form textarea, .animal-form select {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border);
            border-radius: 10px; font-size: 14px; font-family: inherit;
        }
        .animal-form input:focus, .animal-form textarea:focus, .animal-form select:focus { outline: none; border-color: var(--forest); }
        .animal-form textarea { min-height: 80px; resize: vertical; }
        .animal-form .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .animal-form .btn-save {
            flex: 2; padding: 12px; background: linear-gradient(135deg, var(--forest-light), var(--forest));
            color: #fff; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;
        }
        .animal-form .btn-save:hover { opacity: .9; }
        .animal-form .btn-cancel {
            flex: 1; padding: 12px; background: var(--bg); border: 1px solid var(--border);
            border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; color: var(--text-muted);
        }
        .save-success { color: var(--accent); font-size: 13px; font-weight: 600; margin-top: 10px; display: none; }
        .btn-delete {
            padding: 12px; background: #fff; border: 1px solid var(--red);
            border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; color: var(--red);
        }
        .btn-delete:hover { background: var(--red); color: #fff; }

        /* ---- Sub-tabs ---- */
        .sub-tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--bg); border-radius: 10px; padding: 4px; }
        .sub-tab {
            flex: 1; padding: 10px 16px; border-radius: 8px; border: none;
            background: transparent; font-size: 13px; font-weight: 600;
            cursor: pointer; color: var(--text-muted); transition: all .15s; text-align: center;
        }
        .sub-tab.active { background: var(--card); color: var(--text); box-shadow: 0 1px 3px rgba(0,0,0,.06); }
        .sub-tab:hover:not(.active) { color: var(--text); }
        .sub-content { display: none; }
        .sub-content.active { display: block; }

        /* ---- Tips table ---- */
        .tip-content { max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tip-category { display: inline-block; }

        /* ---- Shop grid ---- */
        .shop-card {
            background: var(--bg); border-radius: 12px; padding: 16px;
            display: flex; align-items: center; gap: 12px; cursor: pointer;
            border: 2px solid transparent; transition: all .15s;
        }
        .shop-card:hover { border-color: var(--forest-light); transform: translateY(-2px); }
        .shop-card .shop-icon { font-size: 28px; width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: var(--card); }
        .shop-card .shop-name { font-weight: 600; font-size: 14px; }
        .shop-card .shop-meta { font-size: 12px; color: var(--text-muted); }

        /* ---- Activity Feed ---- */
        .feed-item {
            display: flex; gap: 12px; padding: 14px 0; border-bottom: 1px solid var(--border);
        }
        .feed-item:last-child { border-bottom: none; }
        .feed-icon {
            width: 36px; height: 36px; border-radius: 10px; display: flex;
            align-items: center; justify-content: center; font-size: 18px;
            flex-shrink: 0;
        }
        .feed-icon.session { background: #d1fae5; }
        .feed-icon.hatch { background: #fef3c7; }
        .feed-icon.streak { background: #dbeafe; }
        .feed-icon.badge { background: #ede9fe; }
        .feed-icon.pact { background: #fce7f3; }
        .feed-icon.default { background: var(--bg); }
        .feed-body { flex: 1; }
        .feed-body .username { font-weight: 600; font-size: 13px; }
        .feed-body .desc { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
        .feed-body .time { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

        /* ---- User Detail Modal ---- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.45);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; visibility: hidden; transition: all .2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-box {
            background: var(--card); border-radius: 20px; padding: 32px;
            max-width: 700px; width: 95%; max-height: 85vh; overflow-y: auto;
            transform: scale(.95); transition: transform .2s;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 22px; font-weight: 800; }
        .modal-close {
            background: none; border: none; font-size: 28px; cursor: pointer;
            color: var(--text-muted); line-height: 1;
        }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .detail-stat {
            background: var(--bg); border-radius: 10px; padding: 14px; text-align: center;
        }
        .detail-stat .val { font-size: 22px; font-weight: 800; color: var(--forest-dark); }
        .detail-stat .lbl { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .detail-section { margin-top: 20px; }
        .detail-section h4 { font-size: 14px; font-weight: 700; margin-bottom: 10px; }

        /* ---- Responsive ---- */
        @media (max-width: 900px) {
            .chart-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 700px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 20px; }
        }

        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .empty { text-align: center; padding: 40px; color: var(--text-muted); font-style: italic; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>
<body>

<!-- Login -->
<div class="login-wrap" id="loginScreen">
    <div class="login-card">
        <div style="font-size:56px;margin-bottom:12px">üåø</div>
        <h1>Endura Admin</h1>
        <p>Enter credentials to continue</p>
        <form id="loginForm">
            <input type="text" id="loginApiUrl" placeholder="API URL" value="https://web-production-34028.up.railway.app">
            <input type="password" id="loginKey" placeholder="Admin API Key" required>
            <button type="submit" class="btn">Access Dashboard</button>
        </form>
        <div class="login-error" id="loginError">Invalid API key or server unreachable.</div>
    </div>
</div>

<!-- Shell -->
<div class="shell" id="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <span>üåø</span>
            <div><h2>Endura</h2><small>Admin Dashboard</small></div>
        </div>
        <nav>
            <a class="active" data-page="overview"><span class="icon">üìä</span> Overview</a>
            <a data-page="users"><span class="icon">üë•</span> Users</a>
            <a data-page="donations"><span class="icon">üíö</span> Donations</a>
            <a data-page="content"><span class="icon">ü¶Å</span> Content</a>
            <a data-page="activity"><span class="icon">‚ö°</span> Activity</a>
            <a data-page="analytics"><span class="icon">üìà</span> Analytics</a>
        </nav>
        <div class="api-cfg">
            <label>API Connection</label>
            <div class="api-status" id="sidebarStatus">
                <span class="status-dot fail" id="statusDot"></span>
                <span id="statusText">Not connected</span>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <div class="main">

        <!-- Overview Page -->
        <div class="page active" id="page-overview">
            <h1 class="page-title">Overview</h1>
            <div class="kpi-grid" id="kpiGrid">
                <div class="kpi"><div class="kpi-icon">üë•</div><div class="kpi-val" id="k-users">‚Äî</div><div class="kpi-label">Total Users</div><div class="kpi-sub" id="k-users-sub"></div></div>
                <div class="kpi"><div class="kpi-icon">üü¢</div><div class="kpi-val" id="k-active">‚Äî</div><div class="kpi-label">Active (7d)</div></div>
                <div class="kpi"><div class="kpi-icon">üìö</div><div class="kpi-val" id="k-sessions">‚Äî</div><div class="kpi-label">Study Sessions</div></div>
                <div class="kpi"><div class="kpi-icon">‚è±Ô∏è</div><div class="kpi-val" id="k-hours">‚Äî</div><div class="kpi-label">Study Hours</div></div>
                <div class="kpi"><div class="kpi-icon">üíö</div><div class="kpi-val" id="k-donated">‚Äî</div><div class="kpi-label">Total Donated</div><div class="kpi-sub" id="k-donated-sub"></div></div>
                <div class="kpi"><div class="kpi-icon">üê£</div><div class="kpi-val" id="k-animals">‚Äî</div><div class="kpi-label">Animals Hatched</div></div>
            </div>
            <div class="chart-row">
                <div class="chart-card"><h3>Signups (30 days)</h3><canvas id="chartSignups"></canvas></div>
                <div class="chart-card"><h3>Study Minutes (30 days)</h3><canvas id="chartStudy"></canvas></div>
            </div>
        </div>

        <!-- Users Page -->
        <div class="page" id="page-users">
            <h1 class="page-title">Users</h1>
            <div class="table-card">
                <div class="table-toolbar">
                    <input type="text" id="userSearch" placeholder="Search by username or email...">
                </div>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr>
                            <th>User</th><th>Email</th><th>Study Mins</th>
                            <th>Streak</th><th>Coins</th><th>Animals</th>
                            <th>Donated</th><th>Joined</th>
                        </tr></thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Donations Page -->
        <div class="page" id="page-donations">
            <h1 class="page-title">Donations</h1>
            <div class="kpi-grid" id="donationKpis">
                <div class="kpi"><div class="kpi-icon">üí∞</div><div class="kpi-val" id="d-total">‚Äî</div><div class="kpi-label">Total Raised</div></div>
                <div class="kpi"><div class="kpi-icon">üßæ</div><div class="kpi-val" id="d-count">‚Äî</div><div class="kpi-label">Donations</div></div>
                <div class="kpi"><div class="kpi-icon">ü§ù</div><div class="kpi-val" id="d-donors">‚Äî</div><div class="kpi-label">Unique Donors</div></div>
            </div>
            <div class="table-card">
                <h3>All Donations</h3>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr>
                            <th>Date</th><th>Donor</th><th>Amount</th>
                            <th>Net</th><th>Linked User</th><th>Nonprofit</th>
                        </tr></thead>
                        <tbody id="donationsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Content Page -->
        <div class="page" id="page-content">
            <h1 class="page-title">Content</h1>
            <div class="sub-tabs">
                <button class="sub-tab active" data-subtab="animals" onclick="switchSubTab('animals')">Animals</button>
                <button class="sub-tab" data-subtab="tips" onclick="switchSubTab('tips')">Study Tips</button>
                <button class="sub-tab" data-subtab="shop" onclick="switchSubTab('shop')">Shop</button>
            </div>

            <div class="sub-content active" id="subtab-animals">
                <div class="table-card">
                    <div class="section-header" style="margin-bottom:14px">
                        <h3 style="margin:0">Animals <span id="animalCount" style="color:var(--text-muted);font-weight:500"></span></h3>
                    </div>
                    <div class="animal-grid" id="animalGrid"></div>
                </div>
            </div>

            <div class="sub-content" id="subtab-tips">
                <div class="table-card">
                    <div class="section-header" style="margin-bottom:14px">
                        <h3 style="margin:0">Study Tips <span id="tipCount" style="color:var(--text-muted);font-weight:500"></span></h3>
                    </div>
                    <div style="overflow-x:auto">
                        <table>
                            <thead><tr>
                                <th>Tip</th><th>Category</th><th>Animal</th>
                                <th>Likes</th><th>Author</th><th>Actions</th>
                            </tr></thead>
                            <tbody id="tipsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="sub-content" id="subtab-shop">
                <div class="table-card">
                    <h3>Accessories</h3>
                    <div class="animal-grid" id="shopAccessoriesGrid"></div>
                </div>
                <div class="table-card" style="margin-top:16px">
                    <h3>Decorations</h3>
                    <div class="animal-grid" id="shopDecorationsGrid"></div>
                </div>
            </div>
        </div>

        <!-- Activity Page -->
        <div class="page" id="page-activity">
            <h1 class="page-title">Activity Feed</h1>
            <div class="table-card">
                <div id="feedList"></div>
            </div>
        </div>

        <!-- Analytics (PostHog) Page -->
        <div class="page" id="page-analytics">
            <h1 class="page-title">Product Analytics</h1>

            <div id="phSetup" class="table-card" style="margin-bottom:20px">
                <h3>PostHog Connection</h3>
                <p style="font-size:13px;color:var(--text-muted);margin:8px 0 14px">
                    Enter your <strong>Personal API Key</strong> from
                    <a href="https://us.posthog.com/settings/user-api-keys" target="_blank" style="color:var(--forest)">PostHog Settings ‚Üí Personal API Keys</a>.
                    Create one with <em>insight:read</em>, <em>query:read</em>, and <em>person:read</em> scopes.
                </p>
                <div style="display:flex;gap:10px;align-items:flex-end">
                    <div style="flex:1">
                        <label style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;display:block;margin-bottom:4px">Personal API Key</label>
                        <input type="password" id="phApiKey" placeholder="phx_..." style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:13px;font-family:monospace">
                    </div>
                    <button onclick="connectPostHog()" style="padding:10px 20px;background:var(--forest);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap">Connect</button>
                </div>
                <div id="phStatus" style="margin-top:10px;font-size:13px;display:none"></div>
            </div>

            <div id="phDashboard" style="display:none">
                <div class="kpi-grid" style="margin-bottom:20px">
                    <div class="kpi"><div class="kpi-value" id="ph-events-today">‚Äî</div><div class="kpi-label">Events Today</div></div>
                    <div class="kpi"><div class="kpi-value" id="ph-events-week">‚Äî</div><div class="kpi-label">Events (7d)</div></div>
                    <div class="kpi"><div class="kpi-value" id="ph-persons">‚Äî</div><div class="kpi-label">Identified Users</div></div>
                    <div class="kpi"><div class="kpi-value" id="ph-events-total">‚Äî</div><div class="kpi-label">Events (30d)</div></div>
                </div>

                <div class="table-card" style="margin-bottom:20px">
                    <h3>Top Events <span style="font-weight:400;color:var(--text-muted);font-size:13px">(last 7 days)</span></h3>
                    <div style="overflow-x:auto">
                        <table>
                            <thead><tr><th>Event</th><th>Count</th><th>Bar</th></tr></thead>
                            <tbody id="phTopEvents"></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-card" style="margin-bottom:20px">
                    <h3>Daily Active Users <span style="font-weight:400;color:var(--text-muted);font-size:13px">(last 30 days)</span></h3>
                    <canvas id="phDauChart" height="100"></canvas>
                </div>

                <div class="table-card">
                    <h3>Recent Events <span style="font-weight:400;color:var(--text-muted);font-size:13px">(last 50)</span></h3>
                    <div style="overflow-x:auto">
                        <table>
                            <thead><tr><th>Time</th><th>Event</th><th>User</th><th>Properties</th></tr></thead>
                            <tbody id="phRecentEvents"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Detail Modal -->
<div class="modal-overlay" id="userModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="modalUserTitle">User Detail</h2>
            <button class="modal-close" onclick="closeUserModal()">&times;</button>
        </div>
        <div id="modalUserBody"></div>
    </div>
</div>

<!-- Animal Edit Modal -->
<div class="modal-overlay" id="animalModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="animalModalTitle">Edit Animal</h2>
            <button class="modal-close" onclick="closeAnimalModal()">&times;</button>
        </div>
        <div style="display:flex;gap:20px;align-items:flex-start;margin-bottom:10px">
            <div id="animalImgWrap"></div>
            <div style="flex:1">
                <div style="font-size:13px;color:var(--text-muted)">ID: <span id="animalDetailId"></span></div>
                <div id="animalDetailRarity" style="margin-top:4px"></div>
            </div>
        </div>
        <form class="animal-form" id="animalEditForm">
            <input type="hidden" id="animalEditId">
            <label>Name</label>
            <input type="text" id="animalEditName" required>
            <label>Species</label>
            <input type="text" id="animalEditSpecies">
            <label>Rarity</label>
            <select id="animalEditRarity">
                <option value="common">Common</option>
                <option value="rare">Rare</option>
                <option value="epic">Epic</option>
                <option value="legendary">Legendary</option>
            </select>
            <label>Conservation Status</label>
            <input type="text" id="animalEditStatus">
            <label>Image URL</label>
            <input type="url" id="animalEditImage" placeholder="https://...">
            <label>Description</label>
            <textarea id="animalEditDesc"></textarea>
            <div class="save-success" id="animalSaveSuccess">Saved successfully</div>
            <div class="btn-row">
                <button type="button" class="btn-delete" onclick="deleteAnimal()">Delete</button>
                <button type="button" class="btn-cancel" onclick="closeAnimalModal()">Cancel</button>
                <button type="submit" class="btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Tip Edit Modal -->
<div class="modal-overlay" id="tipModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="tipModalTitle">Edit Tip</h2>
            <button class="modal-close" onclick="closeTipModal()">&times;</button>
        </div>
        <form class="animal-form" id="tipEditForm">
            <input type="hidden" id="tipEditId">
            <label>Content</label>
            <textarea id="tipEditContent" required></textarea>
            <label>Category</label>
            <select id="tipEditCategory">
                <option value="general">General</option>
                <option value="focus">Focus</option>
                <option value="motivation">Motivation</option>
                <option value="productivity">Productivity</option>
                <option value="wellness">Wellness</option>
            </select>
            <label>Animal Name</label>
            <input type="text" id="tipEditAnimal" placeholder="Optional ‚Äî link to animal">
            <div class="save-success" id="tipSaveSuccess">Saved successfully</div>
            <div class="btn-row">
                <button type="button" class="btn-delete" onclick="deleteTip()">Delete</button>
                <button type="button" class="btn-cancel" onclick="closeTipModal()">Cancel</button>
                <button type="submit" class="btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Shop Edit Modal -->
<div class="modal-overlay" id="shopModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="shopModalTitle">Shop Item</h2>
            <button class="modal-close" onclick="closeShopModal()">&times;</button>
        </div>
        <form class="animal-form" id="shopEditForm">
            <input type="hidden" id="shopEditId">
            <label>Name</label>
            <input type="text" id="shopEditName" required>
            <label>Description</label>
            <textarea id="shopEditDesc"></textarea>
            <label>Price (Coins)</label>
            <input type="number" id="shopEditPrice" min="0">
            <label>Category</label>
            <select id="shopEditCategory">
                <option value="accessories">Accessories</option>
                <option value="decorations">Decorations</option>
            </select>
            <label>Rarity</label>
            <select id="shopEditRarity">
                <option value="common">Common</option>
                <option value="rare">Rare</option>
                <option value="epic">Epic</option>
                <option value="legendary">Legendary</option>
            </select>
            <div class="save-success" id="shopSaveSuccess">Note: Shop items are defined in the app code. Edit here for reference only.</div>
            <div class="btn-row">
                <button type="button" class="btn-cancel" onclick="closeShopModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
let API_URL = '';
let API_KEY = '';
let signupsChart = null;
let studyChart = null;

// ----- Auth -----
document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    API_URL = document.getElementById('loginApiUrl').value.replace(/\/+$/, '');
    API_KEY = document.getElementById('loginKey').value;
    try {
        const r = await adminFetch('/admin/overview');
        if (r) {
            localStorage.setItem('adminApiUrl', API_URL);
            localStorage.setItem('adminApiKey', API_KEY);
            enterDashboard();
        }
    } catch {
        document.getElementById('loginError').style.display = 'block';
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('adminApiUrl');
    const key = localStorage.getItem('adminApiKey');
    if (saved && key) {
        API_URL = saved;
        API_KEY = key;
        document.getElementById('loginApiUrl').value = saved;
        enterDashboard();
    }
});

function enterDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('shell').classList.add('active');
    document.getElementById('statusDot').className = 'status-dot ok';
    document.getElementById('statusText').textContent = 'Connected';
    loadOverview();
}

function logout() {
    localStorage.removeItem('adminApiUrl');
    localStorage.removeItem('adminApiKey');
    location.reload();
}

// ----- API -----
async function adminFetch(path) {
    const res = await fetch(API_URL + path, { headers: { 'X-Admin-Key': API_KEY } });
    if (!res.ok) throw new Error(res.status);
    return res.json();
}

// ----- Navigation -----
document.querySelectorAll('.sidebar nav a').forEach(link => {
    link.addEventListener('click', () => {
        document.querySelectorAll('.sidebar nav a').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const page = document.getElementById('page-' + link.dataset.page);
        page.classList.add('active');

        if (link.dataset.page === 'overview') loadOverview();
        else if (link.dataset.page === 'users') loadUsers();
        else if (link.dataset.page === 'donations') loadDonations();
        else if (link.dataset.page === 'content') loadContent();
        else if (link.dataset.page === 'activity') loadActivity();
        else if (link.dataset.page === 'analytics') initAnalytics();
    });
});

// ----- Overview -----
async function loadOverview() {
    try {
        const d = await adminFetch('/admin/overview');
        document.getElementById('k-users').textContent = d.total_users;
        document.getElementById('k-users-sub').textContent = `+${d.signups_7d} this week`;
        document.getElementById('k-active').textContent = d.active_users_7d;
        document.getElementById('k-sessions').textContent = d.total_sessions.toLocaleString();
        document.getElementById('k-hours').textContent = Math.round(d.total_study_minutes / 60).toLocaleString();
        document.getElementById('k-donated').textContent = '$' + d.total_donated.toFixed(2);
        document.getElementById('k-donated-sub').textContent = `${d.total_donation_count} donations`;
        document.getElementById('k-animals').textContent = d.total_animals_hatched;

        renderSignupsChart(d.daily_signups);
        renderStudyChart(d.daily_sessions);
    } catch (e) {
        console.error('Overview load failed', e);
    }
}

function renderSignupsChart(data) {
    const ctx = document.getElementById('chartSignups').getContext('2d');
    if (signupsChart) signupsChart.destroy();
    signupsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.date.slice(5)),
            datasets: [{
                label: 'Signups',
                data: data.map(d => d.count),
                backgroundColor: 'rgba(74,124,89,.6)',
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } },
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }
            }
        }
    });
}

function renderStudyChart(data) {
    const ctx = document.getElementById('chartStudy').getContext('2d');
    if (studyChart) studyChart.destroy();
    studyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.date.slice(5)),
            datasets: [{
                label: 'Minutes',
                data: data.map(d => d.minutes),
                borderColor: 'rgba(74,124,89,.9)',
                backgroundColor: 'rgba(74,124,89,.1)',
                fill: true, tension: .3, pointRadius: 2,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true },
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }
            }
        }
    });
}

// ----- Users -----
let usersData = [];
let searchTimeout = null;

document.getElementById('userSearch').addEventListener('input', e => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => loadUsers(e.target.value), 300);
});

async function loadUsers(search = '') {
    try {
        const q = search ? `?search=${encodeURIComponent(search)}` : '';
        const d = await adminFetch('/admin/users' + q);
        usersData = d.users;
        renderUsersTable();
    } catch (e) { console.error('Users load failed', e); }
}

function renderUsersTable() {
    const body = document.getElementById('usersBody');
    if (!usersData.length) { body.innerHTML = '<tr><td colspan="8" class="empty">No users found</td></tr>'; return; }
    body.innerHTML = usersData.map(u => `
        <tr style="cursor:pointer" onclick="showUserDetail(${u.id})">
            <td><strong>${esc(u.username || '‚Äî')}</strong></td>
            <td>${esc(u.email)}</td>
            <td>${(u.total_study_minutes||0).toLocaleString()}</td>
            <td>${u.current_streak||0} üî•</td>
            <td>${(u.current_coins||0).toLocaleString()}</td>
            <td>${u.animals_hatched||0}</td>
            <td>${u.total_donated ? '$'+u.total_donated.toFixed(2) : '‚Äî'}</td>
            <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : '‚Äî'}</td>
        </tr>
    `).join('');
}

async function showUserDetail(id) {
    try {
        const u = await adminFetch(`/admin/users/${id}`);
        document.getElementById('modalUserTitle').textContent = u.username || u.email;
        document.getElementById('modalUserBody').innerHTML = `
            <div class="detail-grid">
                <div class="detail-stat"><div class="val">${(u.total_study_minutes||0).toLocaleString()}</div><div class="lbl">Study Minutes</div></div>
                <div class="detail-stat"><div class="val">${u.total_sessions||0}</div><div class="lbl">Sessions</div></div>
                <div class="detail-stat"><div class="val">${u.current_streak||0} üî•</div><div class="lbl">Current Streak</div></div>
                <div class="detail-stat"><div class="val">${u.longest_streak||0}</div><div class="lbl">Longest Streak</div></div>
                <div class="detail-stat"><div class="val">${(u.current_coins||0).toLocaleString()}</div><div class="lbl">Eco-Credits</div></div>
                <div class="detail-stat"><div class="val">${u.animals?.length||0}</div><div class="lbl">Animals</div></div>
            </div>
            <p style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Joined ${u.created_at ? new Date(u.created_at).toLocaleDateString() : '‚Äî'} &bull; Last studied ${u.last_study_date ? timeAgo(u.last_study_date) : 'never'}</p>

            ${u.animals?.length ? `<div class="detail-section"><h4>Animals (${u.animals.length})</h4>
                <div style="display:flex;flex-wrap:wrap;gap:8px">${u.animals.map(a => `<span class="badge badge-green">${esc(a.name)}${a.nickname?' ('+esc(a.nickname)+')':''}</span>`).join('')}</div>
            </div>` : ''}

            ${u.badges?.length ? `<div class="detail-section"><h4>Badges (${u.badges.length})</h4>
                <div style="display:flex;flex-wrap:wrap;gap:6px">${u.badges.map(b => `<span class="badge badge-purple">${esc(b.badge_id)}</span>`).join('')}</div>
            </div>` : ''}

            ${u.donations?.length ? `<div class="detail-section"><h4>Donations (${u.donations.length})</h4>
                <table><thead><tr><th>Amount</th><th>Nonprofit</th><th>Date</th></tr></thead>
                <tbody>${u.donations.map(d => `<tr><td>$${d.amount?.toFixed(2)}</td><td>${esc(d.nonprofit_name||'')}</td><td>${d.donation_date||'‚Äî'}</td></tr>`).join('')}</tbody></table>
            </div>` : ''}

            ${u.recent_sessions?.length ? `<div class="detail-section"><h4>Recent Sessions</h4>
                <table><thead><tr><th>Duration</th><th>Coins</th><th>Subject</th><th>Date</th></tr></thead>
                <tbody>${u.recent_sessions.map(s => `<tr><td>${s.duration_minutes} min</td><td>${s.coins_earned}</td><td>${esc(s.subject||'‚Äî')}</td><td>${s.started_at?timeAgo(s.started_at):'‚Äî'}</td></tr>`).join('')}</tbody></table>
            </div>` : ''}
        `;
        document.getElementById('userModal').classList.add('active');
    } catch (e) { console.error('User detail failed', e); }
}

function closeUserModal() { document.getElementById('userModal').classList.remove('active'); }
document.getElementById('userModal').addEventListener('click', e => { if (e.target.id === 'userModal') closeUserModal(); });

// ----- Donations -----
async function loadDonations() {
    try {
        const d = await adminFetch('/admin/donations');
        document.getElementById('d-total').textContent = '$' + d.total_raised.toFixed(2);
        document.getElementById('d-count').textContent = d.total_count;
        document.getElementById('d-donors').textContent = d.unique_donors;

        const body = document.getElementById('donationsBody');
        if (!d.donations.length) { body.innerHTML = '<tr><td colspan="6" class="empty">No donations yet</td></tr>'; return; }
        body.innerHTML = d.donations.map(don => `
            <tr>
                <td>${don.donation_date || (don.created_at ? new Date(don.created_at).toLocaleDateString() : '‚Äî')}</td>
                <td>${esc((don.donor_first_name||'') + ' ' + (don.donor_last_name||'')).trim() || '‚Äî'}</td>
                <td><strong>$${don.amount?.toFixed(2)}</strong></td>
                <td>${don.net_amount ? '$'+don.net_amount.toFixed(2) : '‚Äî'}</td>
                <td>${don.linked_user ? `<span class="badge badge-green">${esc(don.linked_user)}</span>` : '<span class="badge badge-amber">Unlinked</span>'}</td>
                <td>${esc(don.nonprofit_name||'‚Äî')}</td>
            </tr>
        `).join('');
    } catch (e) { console.error('Donations load failed', e); }
}

// ----- Content Sub-tabs -----
function switchSubTab(name) {
    document.querySelectorAll('.sub-tab').forEach(t => t.classList.toggle('active', t.dataset.subtab === name));
    document.querySelectorAll('.sub-content').forEach(c => c.classList.toggle('active', c.id === 'subtab-' + name));
    if (name === 'tips' && allTips.length === 0) loadTips();
    if (name === 'shop') renderShopGrids();
}

// ----- Content: Animals -----
let allAnimals = [];

async function loadContent() {
    try {
        allAnimals = await fetch(API_URL + '/animals').then(r => r.json());
        renderAnimalGrid();
    } catch (e) { console.error('Content load failed', e); }
}

function renderAnimalGrid() {
    document.getElementById('animalCount').textContent = `(${allAnimals.length})`;
    const grid = document.getElementById('animalGrid');
    grid.innerHTML = allAnimals.map(a => {
        const rarityColors = { common: 'badge-green', rare: 'badge-blue', epic: 'badge-purple', legendary: 'badge-amber' };
        const imgHtml = a.image_url
            ? `<img class="animal-img" src="${esc(a.image_url)}" alt="${esc(a.name)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><span class="emoji" style="display:none">${getAnimalEmoji(a.name)}</span>`
            : `<span class="emoji">${getAnimalEmoji(a.name)}</span>`;
        return `<div class="animal-card" onclick="openAnimalDetail(${a.id})">
            ${imgHtml}
            <div>
                <div class="name">${esc(a.name)}</div>
                <div class="status">${esc(a.conservation_status || '')}</div>
                <div class="rarity-tag"><span class="badge ${rarityColors[a.rarity] || 'badge-green'}">${esc(a.rarity || 'common')}</span></div>
            </div>
        </div>`;
    }).join('');
}

function openAnimalDetail(id) {
    const a = allAnimals.find(x => x.id === id);
    if (!a) return;
    document.getElementById('animalEditId').value = a.id;
    document.getElementById('animalDetailId').textContent = a.id;
    document.getElementById('animalModalTitle').textContent = getAnimalEmoji(a.name) + ' ' + a.name;
    document.getElementById('animalEditName').value = a.name || '';
    document.getElementById('animalEditSpecies').value = a.species || '';
    document.getElementById('animalEditRarity').value = a.rarity || 'common';
    document.getElementById('animalEditStatus').value = a.conservation_status || '';
    document.getElementById('animalEditImage').value = a.image_url || '';
    document.getElementById('animalEditDesc').value = a.description || '';

    const rarityColors = { common: 'badge-green', rare: 'badge-blue', epic: 'badge-purple', legendary: 'badge-amber' };
    document.getElementById('animalDetailRarity').innerHTML = `<span class="badge ${rarityColors[a.rarity]||'badge-green'}">${esc(a.rarity||'common')}</span>`;

    const wrap = document.getElementById('animalImgWrap');
    if (a.image_url) {
        wrap.innerHTML = `<img class="animal-detail-img" src="${esc(a.image_url)}" onerror="this.outerHTML='<div class=animal-detail-placeholder>${getAnimalEmoji(a.name)}</div>'">`;
    } else {
        wrap.innerHTML = `<div class="animal-detail-placeholder">${getAnimalEmoji(a.name)}</div>`;
    }

    document.getElementById('animalSaveSuccess').style.display = 'none';
    document.getElementById('animalModal').classList.add('active');
}

function closeAnimalModal() { document.getElementById('animalModal').classList.remove('active'); }
document.getElementById('animalModal').addEventListener('click', e => { if (e.target.id === 'animalModal') closeAnimalModal(); });

document.getElementById('animalEditForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('animalEditId').value;
    const body = {
        name: document.getElementById('animalEditName').value,
        species: document.getElementById('animalEditSpecies').value,
        rarity: document.getElementById('animalEditRarity').value,
        conservation_status: document.getElementById('animalEditStatus').value,
        image_url: document.getElementById('animalEditImage').value || null,
        description: document.getElementById('animalEditDesc').value || null,
    };
    try {
        const res = await fetch(API_URL + '/admin/animals/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Key': API_KEY },
            body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error(res.status);
        const updated = await res.json();
        const idx = allAnimals.findIndex(a => a.id === updated.id);
        if (idx !== -1) allAnimals[idx] = { ...allAnimals[idx], ...updated };
        renderAnimalGrid();
        document.getElementById('animalSaveSuccess').style.display = 'block';
        document.getElementById('animalModalTitle').textContent = getAnimalEmoji(updated.name) + ' ' + updated.name;
        if (updated.image_url) {
            document.getElementById('animalImgWrap').innerHTML = `<img class="animal-detail-img" src="${esc(updated.image_url)}">`;
        }
        setTimeout(() => { document.getElementById('animalSaveSuccess').style.display = 'none'; }, 2000);
    } catch (err) {
        alert('Failed to save: ' + err.message);
    }
});

async function deleteAnimal() {
    const id = document.getElementById('animalEditId').value;
    const name = document.getElementById('animalEditName').value;
    if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
    try {
        const res = await fetch(API_URL + '/admin/animals/' + id, {
            method: 'DELETE',
            headers: { 'X-Admin-Key': API_KEY },
        });
        if (!res.ok) throw new Error(res.status);
        allAnimals = allAnimals.filter(a => a.id !== parseInt(id));
        renderAnimalGrid();
        closeAnimalModal();
    } catch (err) {
        alert('Failed to delete: ' + err.message);
    }
}

// ----- Content: Study Tips -----
let allTips = [];

async function loadTips() {
    try {
        const d = await adminFetch('/admin/tips');
        allTips = d.tips || [];
        renderTipsTable();
    } catch (e) { console.error('Tips load failed', e); }
}

function renderTipsTable() {
    document.getElementById('tipCount').textContent = `(${allTips.length})`;
    const body = document.getElementById('tipsBody');
    if (!allTips.length) { body.innerHTML = '<tr><td colspan="6" class="empty">No study tips yet</td></tr>'; return; }
    body.innerHTML = allTips.map(t => `
        <tr style="cursor:pointer" onclick="openTipDetail(${t.id})">
            <td class="tip-content" title="${esc(t.content)}">${esc(t.content)}</td>
            <td><span class="badge badge-blue tip-category">${esc(t.category || 'general')}</span></td>
            <td>${esc(t.animal_name || '‚Äî')}</td>
            <td>üëç ${t.likes_count} / üëé ${t.dislikes_count}</td>
            <td>${esc(t.author || '‚Äî')}</td>
            <td><button class="btn-delete" style="padding:6px 12px;font-size:12px" onclick="event.stopPropagation();deleteTipDirect(${t.id})">Delete</button></td>
        </tr>
    `).join('');
}

function openTipDetail(id) {
    const t = allTips.find(x => x.id === id);
    if (!t) return;
    document.getElementById('tipEditId').value = t.id;
    document.getElementById('tipModalTitle').textContent = 'Edit Tip #' + t.id;
    document.getElementById('tipEditContent').value = t.content || '';
    document.getElementById('tipEditCategory').value = t.category || 'general';
    document.getElementById('tipEditAnimal').value = t.animal_name || '';
    document.getElementById('tipSaveSuccess').style.display = 'none';
    document.getElementById('tipModal').classList.add('active');
}

function closeTipModal() { document.getElementById('tipModal').classList.remove('active'); }
document.getElementById('tipModal').addEventListener('click', e => { if (e.target.id === 'tipModal') closeTipModal(); });

document.getElementById('tipEditForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('tipEditId').value;
    const body = {
        content: document.getElementById('tipEditContent').value,
        category: document.getElementById('tipEditCategory').value,
        animal_name: document.getElementById('tipEditAnimal').value || null,
    };
    try {
        const res = await fetch(API_URL + '/admin/tips/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Key': API_KEY },
            body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error(res.status);
        const updated = await res.json();
        const idx = allTips.findIndex(t => t.id === updated.id);
        if (idx !== -1) allTips[idx] = { ...allTips[idx], ...updated };
        renderTipsTable();
        document.getElementById('tipSaveSuccess').textContent = 'Saved successfully';
        document.getElementById('tipSaveSuccess').style.display = 'block';
        setTimeout(() => { document.getElementById('tipSaveSuccess').style.display = 'none'; }, 2000);
    } catch (err) {
        alert('Failed to save: ' + err.message);
    }
});

async function deleteTip() {
    const id = document.getElementById('tipEditId').value;
    if (!confirm('Delete this study tip? This cannot be undone.')) return;
    await deleteTipById(id);
    closeTipModal();
}

async function deleteTipDirect(id) {
    if (!confirm('Delete this study tip? This cannot be undone.')) return;
    await deleteTipById(id);
}

async function deleteTipById(id) {
    try {
        const res = await fetch(API_URL + '/admin/tips/' + id, {
            method: 'DELETE',
            headers: { 'X-Admin-Key': API_KEY },
        });
        if (!res.ok) throw new Error(res.status);
        allTips = allTips.filter(t => t.id !== parseInt(id));
        renderTipsTable();
    } catch (err) {
        alert('Failed to delete: ' + err.message);
    }
}

// ----- Content: Shop -----
const SHOP_ITEMS = [
    { id: 'acc_tophat', name: 'Top Hat', emoji: 'üé©', description: 'A dapper top hat for your most distinguished animal', price: 40, category: 'accessories', rarity: 'common' },
    { id: 'acc_sunnies', name: 'Sunnies', emoji: 'üï∂Ô∏è', description: 'Cool shades for the coolest creatures', price: 35, category: 'accessories', rarity: 'common' },
    { id: 'acc_crown', name: 'Crown', emoji: 'üëë', description: 'A royal crown fit for the king of the sanctuary', price: 80, category: 'accessories', rarity: 'epic' },
    { id: 'acc_gradcap', name: 'Graduation Cap', emoji: 'üéì', description: 'Celebrate your study achievements in style', price: 60, category: 'accessories', rarity: 'rare' },
    { id: 'acc_eyemask', name: 'Eye Mask', emoji: 'üò¥', description: 'For animals that deserve a cozy rest after your study session', price: 45, category: 'accessories', rarity: 'common' },
    { id: 'acc_partyhat', name: 'Party Hat', emoji: 'ü•≥', description: 'A festive party hat for celebration time', price: 50, category: 'accessories', rarity: 'rare' },
    { id: 'acc_halo', name: 'Halo', emoji: 'üòá', description: 'A golden halo for your most angelic animal', price: 90, category: 'accessories', rarity: 'epic' },
    { id: 'acc_bow', name: 'Bow Tie', emoji: 'üéÄ', description: 'A classy white bow tie for formal occasions', price: 55, category: 'accessories', rarity: 'rare' },
    { id: 'dec_daisy', name: 'Daisy Patch', emoji: 'üåº', description: 'A cheerful bunch of daisies to brighten your sanctuary', price: 30, category: 'decorations', rarity: 'common' },
    { id: 'dec_mushroom', name: 'Mushroom', emoji: 'üçÑ', description: 'A whimsical fairy-tale mushroom', price: 40, category: 'decorations', rarity: 'common' },
    { id: 'dec_tree', name: 'Tree', emoji: 'üå≥', description: 'A shady tree for animals to rest under', price: 55, category: 'decorations', rarity: 'rare' },
    { id: 'dec_tulips', name: 'Tulips', emoji: 'üå∑', description: 'A vibrant cluster of colourful tulips', price: 50, category: 'decorations', rarity: 'rare' },
    { id: 'dec_stones', name: 'Zen Stones', emoji: 'ü™®', description: 'A calming stack of smooth zen stones', price: 45, category: 'decorations', rarity: 'common' },
    { id: 'dec_bamboo', name: 'Bamboo', emoji: 'üéã', description: 'Tall green bamboo stalks swaying gently', price: 65, category: 'decorations', rarity: 'rare' },
];

function renderShopGrids() {
    const rarityColors = { common: 'badge-green', rare: 'badge-blue', epic: 'badge-purple', legendary: 'badge-amber' };
    const makeCard = item => `
        <div class="shop-card" onclick="openShopDetail('${item.id}')">
            <div class="shop-icon">${item.emoji}</div>
            <div>
                <div class="shop-name">${esc(item.name)}</div>
                <div class="shop-meta">${item.price} coins &middot; <span class="badge ${rarityColors[item.rarity]||'badge-green'}">${item.rarity}</span></div>
            </div>
        </div>`;
    document.getElementById('shopAccessoriesGrid').innerHTML = SHOP_ITEMS.filter(i => i.category === 'accessories').map(makeCard).join('');
    document.getElementById('shopDecorationsGrid').innerHTML = SHOP_ITEMS.filter(i => i.category === 'decorations').map(makeCard).join('');
}

function openShopDetail(id) {
    const item = SHOP_ITEMS.find(i => i.id === id);
    if (!item) return;
    document.getElementById('shopEditId').value = item.id;
    document.getElementById('shopModalTitle').textContent = item.emoji + ' ' + item.name;
    document.getElementById('shopEditName').value = item.name;
    document.getElementById('shopEditDesc').value = item.description;
    document.getElementById('shopEditPrice').value = item.price;
    document.getElementById('shopEditCategory').value = item.category;
    document.getElementById('shopEditRarity').value = item.rarity;
    document.getElementById('shopSaveSuccess').style.display = 'block';
    document.getElementById('shopModal').classList.add('active');
}
function closeShopModal() { document.getElementById('shopModal').classList.remove('active'); }
document.getElementById('shopModal').addEventListener('click', e => { if (e.target.id === 'shopModal') closeShopModal(); });

const ANIMAL_EMOJIS = {
    'Red Panda':'üêº','Sea Turtle':'üê¢','Penguin':'üêß','Koala':'üê®','Flamingo':'ü¶©',
    'Giant Panda':'üêº','Snow Leopard':'üêÜ','Orangutan':'ü¶ß','Elephant':'üêò',
    'Polar Bear':'üêª‚Äç‚ùÑÔ∏è','Tiger':'üêÖ','Gorilla':'ü¶ç','Blue Whale':'üêã','Cheetah':'üêÜ',
    'Rhinoceros':'ü¶è','Amur Leopard':'üêÜ','Vaquita':'üê¨','Sumatran Rhino':'ü¶è',
    'Kakapo':'ü¶ú','Axolotl':'ü¶é','Saola':'ü¶å'
};
function getAnimalEmoji(name) { return ANIMAL_EMOJIS[name] || 'üêæ'; }

// ----- Activity -----
const EVENT_META = {
    session_complete: { icon: 'üìö', cls: 'session' },
    animal_hatched: { icon: 'üê£', cls: 'hatch' },
    streak_milestone: { icon: 'üî•', cls: 'streak' },
    badge_earned: { icon: 'üèÖ', cls: 'badge' },
    pact_created: { icon: 'ü§ù', cls: 'pact' },
};

async function loadActivity() {
    try {
        const d = await adminFetch('/admin/activity');
        const list = document.getElementById('feedList');
        if (!d.events.length) { list.innerHTML = '<div class="empty">No activity yet</div>'; return; }
        list.innerHTML = d.events.map(e => {
            const meta = EVENT_META[e.event_type] || { icon: '‚ö°', cls: 'default' };
            return `<div class="feed-item">
                <div class="feed-icon ${meta.cls}">${meta.icon}</div>
                <div class="feed-body">
                    <div class="username">${esc(e.username||'Unknown')}</div>
                    <div class="desc">${esc(e.description||e.event_type)}</div>
                    <div class="time">${e.created_at ? timeAgo(e.created_at) : ''}</div>
                </div>
            </div>`;
        }).join('');
    } catch (e) { console.error('Activity load failed', e); }
}

// ----- Helpers -----
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function timeAgo(iso) {
    const diff = Date.now() - new Date(iso).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    if (days < 30) return days + 'd ago';
    return new Date(iso).toLocaleDateString();
}

// ----- PostHog Analytics -----
const PH_HOST = 'https://us.posthog.com';
let PH_KEY = '';
let phProjectId = null;
let phDauChart = null;

function initAnalytics() {
    const saved = localStorage.getItem('phPersonalKey');
    if (saved) {
        PH_KEY = saved;
        document.getElementById('phApiKey').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        loadPostHogData();
    }
}

async function phFetch(path) {
    const res = await fetch(PH_HOST + path, {
        headers: { 'Authorization': 'Bearer ' + PH_KEY }
    });
    if (!res.ok) throw new Error(res.status);
    return res.json();
}

async function connectPostHog() {
    const input = document.getElementById('phApiKey').value.trim();
    if (!input || input === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
        if (PH_KEY) { loadPostHogData(); return; }
        showPhStatus('Please enter a Personal API Key', 'red');
        return;
    }
    PH_KEY = input;
    showPhStatus('Connecting...', 'var(--text-muted)');
    try {
        const data = await phFetch('/api/projects/');
        if (data.results && data.results.length > 0) {
            phProjectId = data.results[0].id;
            localStorage.setItem('phPersonalKey', PH_KEY);
            showPhStatus('Connected to project: ' + esc(data.results[0].name), 'var(--accent)');
            loadPostHogData();
        } else {
            showPhStatus('No projects found', 'var(--red)');
        }
    } catch (e) {
        showPhStatus('Failed to connect: ' + e.message + '. Check your key has correct scopes.', 'var(--red)');
    }
}

function showPhStatus(msg, color) {
    const el = document.getElementById('phStatus');
    el.textContent = msg;
    el.style.color = color;
    el.style.display = 'block';
}

async function loadPostHogData() {
    try {
        if (!phProjectId) {
            const data = await phFetch('/api/projects/');
            if (data.results && data.results.length > 0) phProjectId = data.results[0].id;
            else return;
        }
        document.getElementById('phDashboard').style.display = 'block';
        showPhStatus('Connected', 'var(--accent)');

        const now = new Date();
        const day1 = new Date(now); day1.setDate(day1.getDate() - 1);
        const day7 = new Date(now); day7.setDate(day7.getDate() - 7);
        const day30 = new Date(now); day30.setDate(day30.getDate() - 30);
        const fmt = d => d.toISOString().split('T')[0];

        // Parallel queries
        const [eventsToday, events7d, events30d, topEvents, recentEvents, persons] = await Promise.all([
            phQuery(`SELECT count() FROM events WHERE timestamp > '${fmt(day1)}'`),
            phQuery(`SELECT count() FROM events WHERE timestamp > '${fmt(day7)}'`),
            phQuery(`SELECT count() FROM events WHERE timestamp > '${fmt(day30)}'`),
            phQuery(`SELECT event, count() as cnt FROM events WHERE timestamp > '${fmt(day7)}' AND event NOT LIKE '$%' GROUP BY event ORDER BY cnt DESC LIMIT 15`),
            phQuery(`SELECT timestamp, event, distinct_id, properties FROM events WHERE event NOT LIKE '$%' ORDER BY timestamp DESC LIMIT 50`),
            phQuery(`SELECT count() FROM persons`),
        ]);

        document.getElementById('ph-events-today').textContent = formatNum(extractCount(eventsToday));
        document.getElementById('ph-events-week').textContent = formatNum(extractCount(events7d));
        document.getElementById('ph-events-total').textContent = formatNum(extractCount(events30d));
        document.getElementById('ph-persons').textContent = formatNum(extractCount(persons));

        renderTopEvents(topEvents);
        renderRecentEvents(recentEvents);

        // DAU chart
        const dauData = await phQuery(`SELECT toDate(timestamp) as day, count(DISTINCT distinct_id) as users FROM events WHERE timestamp > '${fmt(day30)}' GROUP BY day ORDER BY day`);
        renderDauChart(dauData);

    } catch (e) {
        console.error('PostHog load failed', e);
        showPhStatus('Error loading data: ' + e.message, 'var(--red)');
    }
}

async function phQuery(sql) {
    const res = await fetch(PH_HOST + '/api/projects/' + phProjectId + '/query/', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + PH_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: { kind: 'HogQLQuery', query: sql } }),
    });
    if (!res.ok) throw new Error('Query failed: ' + res.status);
    return res.json();
}

function extractCount(result) {
    try { return result.results[0][0]; } catch { return 0; }
}

function formatNum(n) {
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return String(n);
}

function renderTopEvents(data) {
    const body = document.getElementById('phTopEvents');
    if (!data.results || !data.results.length) { body.innerHTML = '<tr><td colspan="3" class="empty">No events yet</td></tr>'; return; }
    const max = data.results[0][1];
    body.innerHTML = data.results.map(r => {
        const pct = Math.round((r[1] / max) * 100);
        return `<tr>
            <td><strong>${esc(r[0])}</strong></td>
            <td>${r[1].toLocaleString()}</td>
            <td style="width:40%"><div style="background:linear-gradient(90deg,var(--forest-light),var(--forest));height:20px;border-radius:6px;width:${pct}%"></div></td>
        </tr>`;
    }).join('');
}

function renderRecentEvents(data) {
    const body = document.getElementById('phRecentEvents');
    if (!data.results || !data.results.length) { body.innerHTML = '<tr><td colspan="4" class="empty">No events yet</td></tr>'; return; }
    body.innerHTML = data.results.slice(0, 50).map(r => {
        const ts = r[0] ? timeAgo(r[0]) : '‚Äî';
        let props = '';
        try {
            const p = typeof r[3] === 'string' ? JSON.parse(r[3]) : r[3];
            if (p) {
                const keys = Object.keys(p).filter(k => !k.startsWith('$')).slice(0, 3);
                props = keys.map(k => `<span class="badge badge-blue" style="margin-right:4px">${esc(k)}: ${esc(String(p[k]).substring(0, 30))}</span>`).join('');
            }
        } catch {}
        return `<tr>
            <td style="white-space:nowrap">${ts}</td>
            <td><strong>${esc(r[1])}</strong></td>
            <td style="font-size:12px;color:var(--text-muted)">${esc(String(r[2] || '‚Äî').substring(0, 20))}</td>
            <td>${props || '‚Äî'}</td>
        </tr>`;
    }).join('');
}

function renderDauChart(data) {
    if (!data.results || !data.results.length) return;
    const ctx = document.getElementById('phDauChart').getContext('2d');
    if (phDauChart) phDauChart.destroy();
    phDauChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.results.map(r => r[0]),
            datasets: [{
                label: 'Daily Active Users',
                data: data.results.map(r => r[1]),
                backgroundColor: 'rgba(107,155,122,0.6)',
                borderRadius: 4,
            }],
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 11 } } },
                y: { beginAtZero: true, ticks: { font: { size: 11 } } },
            },
        },
    });
}
</script>
</body>
</html>
